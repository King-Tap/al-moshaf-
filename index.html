<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المصحف أوفلاين</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; margin: 0; padding: 0; direction: rtl; }
        .header { background: #064e3b; color: white; padding: 15px; text-align: center; position: sticky; top: 0; }
        .container { padding: 15px; }
        .card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer; }
        .quran-text { font-size: 24px; line-height: 2; text-align: justify; background: white; padding: 20px; border-radius: 8px; }
        .hidden { display: none; }
        .download-btn { background: #eab308; color: black; border: none; padding: 10px; width: 100%; font-weight: bold; border-radius: 5px; margin-bottom: 15px; }
        .btn-back { background: #666; color: white; border: none; padding: 10px; width: 100%; margin-top: 20px; border-radius: 5px; }
        .ayah-num { color: #064e3b; font-weight: bold; border: 1px solid #064e3b; border-radius: 50%; padding: 2px 5px; font-size: 14px; margin: 0 5px; }
    </style>
</head>
<body>

<div class="header">
    <h2 id="title">المصحف الشامل (أوفلاين)</h2>
</div>

<div class="container">
    <button id="downloadSection" class="download-btn" onclick="downloadQuran()">تحميل المصحف للعمل بدون إنترنت</button>

    <div id="surahList"></div>

    <div id="readingView" class="hidden">
        <div id="quranContent" class="quran-text"></div>
        <button class="btn-back" onclick="showIndex()">العودة للفهرس</button>
    </div>
</div>

<script>
    let quranData = null;

    // محاولة تحميل البيانات من الذاكرة فوراً عند فتح التطبيق
    window.onload = function() {
        const savedData = localStorage.getItem('quran_data');
        if (savedData) {
            quranData = JSON.parse(savedData);
            document.getElementById('downloadSection').classList.add('hidden');
            renderIndex();
        } else {
            fetchIndex();
        }
    };

    // جلب الفهرس فقط من الإنترنت في أول مرة
    function fetchIndex() {
        fetch('https://api.alquran.cloud/v1/surah')
            .then(res => res.json())
            .then(data => {
                renderIndexFromApi(data.data);
            });
    }

    function renderIndexFromApi(surahs) {
        const list = document.getElementById('surahList');
        list.innerHTML = '';
        surahs.forEach(s => {
            list.innerHTML += `<div class="card" onclick="alert('يرجى تحميل المصحف أولاً للبدء بقراءة هذه السورة')">${s.number}. ${s.name}</div>`;
        });
    }

    // تحميل المصحف كاملاً وحفظه
    function downloadQuran() {
        const btn = document.getElementById('downloadSection');
        btn.innerText = 'جاري التحميل... يرجى الانتظار';
        btn.disabled = true;

        fetch('https://api.alquran.cloud/v1/quran/quran-uthmani')
            .then(res => res.json())
            .then(data => {
                quranData = data.data.surahs;
                localStorage.setItem('quran_data', JSON.stringify(quranData));
                btn.classList.add('hidden');
                renderIndex();
                alert('تم التحميل بنجاح! التطبيق سيعمل الآن بدون إنترنت.');
            })
            .catch(err => {
                alert('فشل التحميل، تأكد من اتصال الإنترنت');
                btn.innerText = 'تحميل المصحف للعمل بدون إنترنت';
                btn.disabled = false;
            });
    }

    function renderIndex() {
        const list = document.getElementById('surahList');
        list.innerHTML = '';
        quranData.forEach(s => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerText = `${s.number}. ${s.name}`;
            div.onclick = () => openSurah(s.number);
            list.appendChild(div);
        });
        document.getElementById('surahList').classList.remove('hidden');
        document.getElementById('readingView').classList.add('hidden');
    }

    function openSurah(num) {
        const surah = quranData.find(s => s.number === num);
        document.getElementById('title').innerText = surah.name;
        document.getElementById('surahList').classList.add('hidden');
        document.getElementById('readingView').classList.remove('hidden');
        
        const content = document.getElementById('quranContent');
        content.innerHTML = '';
        surah.ayahs.forEach(ayah => {
            content.innerHTML += `${ayah.text} <span class="ayah-num">${ayah.numberInSurah}</span> `;
        });
        window.scrollTo(0,0);
    }

    function showIndex() {
        document.getElementById('title').innerText = 'المصحف الشامل (أوفلاين)';
        document.getElementById('surahList').classList.remove('hidden');
        document.getElementById('readingView').classList.add('hidden');
    }
</script>

</body>
</html>
